<!-- 需要读取cart.txt -->
<!DOCTYPE html>
<html lang="en">
   <head>
      <!-- basic -->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <!-- mobile metas -->
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="viewport" content="initial-scale=1, maximum-scale=1">
      <!-- site metas -->
      <title>Shopping Cart</title>
      <meta name="keywords" content="">
      <meta name="description" content="">
      <meta name="author" content="">
      <!-- bootstrap css -->
      <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
      <!-- style css -->
      <link rel="stylesheet" type="text/css" href="css/style.css">
      <!-- Responsive-->
      <link rel="stylesheet" href="css/responsive.css">
      <!-- fevicon -->
      <link rel="icon" href="images/fevicon.png" type="image/gif" />
      <!-- Scrollbar Custom CSS -->
      <link rel="stylesheet" href="css/jquery.mCustomScrollbar.min.css">
      <!-- Tweaks for older IEs-->
      <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
      <!-- fonts -->
      <link href="https://fonts.googleapis.com/css?family=Great+Vibes|Open+Sans:400,700&display=swap&subset=latin-ext" rel="stylesheet">
      <!-- owl stylesheets --> 
      <link rel="stylesheet" href="css/owl.carousel.min.css">
      <link rel="stylesheet" href="css/owl.theme.default.min.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" media="screen">
      <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
   </head>
   <body>
      <!-- header section start -->
      <div class="header_section">
         <div class="container-fluid">
            <nav class="navbar navbar-light bg-light justify-content-between">
               <div id="mySidenav" class="sidenav">
                  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
                  <a href="index.php">Home</a>
                  <a href="products.php">Products</a>
                  <a href="about.html">About</a>
                  <!-- <a href="client.html">Client</a> -->
                  <a href="contact.html">Contact</a>
               </div>
               <span class="toggle_icon" onclick="openNav()"><img src="images/toggle-icon.png"></span>
               <a class="logo" href="index.php"><img src="images/logo.png"></a></a>
               <form class="form-inline ">
                  <div class="login_text">
                     <ul>
                        <li><a href="login.php"><img src="images/user-icon.png"></a></li>
                        <li><a href="cart.html"><img src="images/bag-icon.png"></a></li>
                        <li><a href="search.html"><img src="images/search-icon.png"></a></li>
                     </ul>
                  </div>
               </form>
            </nav>
         </div>
      </div>
      <!-- header section end -->
      <!-- cart section start -->
      <div class="cart_section layout_padding">
         <div class="container mt-5">
            <h2>Your Shopping Cart</h2>
            <table class="table" id="cart-table">
               <thead>
               <tr>
                <th>Product</th>
                <th>Description</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th>Action</th>
                <th></th>
               </tr>
               </thead>
            <tbody id="cartItems">
               <!-- Rows will be dynamically added here -->
            </tbody>
            </table>

            <div class="text-right">
               <h3>Total: $<span id="totalPrice">0</span></h3>
               <button class="btn btn-primary" id="checkout">Checkout</button>
            </div> 
            
            <script>
               window.onload = function() {
                  var xhttp = new XMLHttpRequest();
                  xhttp.onreadystatechange = function() {
                     if (this.readyState === 4 && this.status === 200) {
                        var fileContent = this.responseText;
                        var purchases = fileContent.split('\n'); // 每行读取
                        var total = 0;
                        var tableBody = document.getElementById("cartItems");
                        var totalElement = document.getElementById("totalPrice");
                        purchases.forEach(function(purchase) {
                           var columns = purchase.split(','); // 逗号分隔
                           var product = columns[0];
                           var description = columns[1];
                           var price = parseFloat(columns[2]);
                           var quantity = columns[3];

                           var subtotal = price * quantity;

                           var row = document.createElement("tr");

                           var productCell = document.createElement("td");
                           productCell.innerText = product;
                           row.appendChild(productCell);

                           var dscrptCell = document.createElement("td");
                           dscrptCell.innerText = description;
                           row.appendChild(dscrptCell);

                           var priceCell = document.createElement("td");
                           priceCell.innerText = price;
                           row.appendChild(priceCell);

                           var quantityCell = document.createElement("td");
                           var decreaseButton = document.createElement("button");
                           decreaseButton.innerText = "-";
                           decreaseButton.addEventListener("click", function() {

                              if (quantity == 1) {
                                 total -= subtotal;
                                 totalElement.innerText = total.toFixed(2);
                                 row.remove();

                                 var xhr = new XMLHttpRequest();
                        xhr.open("POST", "remove_cart.php", true);
                        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                        xhr.send("product=" + encodeURIComponent(product));
                              }
                              if (quantity > 1) {
                                 quantity--;
                                 quantityValue.innerText = quantity;

                                 subtotal = price * quantity;
                                 subtotalCell.innerText = subtotal.toFixed(2);

                                 total -= price;
                                 totalElement.innerText = total.toFixed(2);

                                 var xhr = new XMLHttpRequest();
                        xhr.open("POST", "decr_cart.php", true);
                        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                        xhr.send("product=" + encodeURIComponent(product) + "&quantity=" + quantity);
                              }
                           });
                           quantityCell.appendChild(decreaseButton);

                           var quantityValue = document.createElement("span");
                           quantityValue.innerText = quantity;
                           quantityCell.appendChild(quantityValue);

                           var increaseButton = document.createElement("button");
                           increaseButton.innerText = "+";
                           increaseButton.addEventListener("click", function() {
                              quantity++;
                              quantityValue.innerText = quantity;

                              subtotal = price * quantity;
                              subtotalCell.innerText = subtotal.toFixed(2);

                              total += price;
                              totalElement.innerText = total.toFixed(2);
                              var xhr = new XMLHttpRequest();
                        xhr.open("POST", "incr_cart.php", true);
                        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                        xhr.send("product=" + encodeURIComponent(product) + "&quantity=" + quantity);
                           });
                           quantityCell.appendChild(increaseButton);

                           row.appendChild(quantityCell);


                           var subtotalCell = document.createElement("td");
                           subtotalCell.innerText = subtotal.toFixed(2); 
                           total += subtotal;
                           row.appendChild(subtotalCell);

                           var removeCell = document.createElement("td");
                           var removeButton = document.createElement("button");
                           removeButton.innerText = "Remove";
                           removeButton.addEventListener("click", function() {

                              total -= subtotal;
                              totalElement.innerText = total.toFixed(2);
                              row.remove(); 

                              var xhr = new XMLHttpRequest();
                        xhr.open("POST", "remove_cart.php", true);
                        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                        xhr.send("product=" + encodeURIComponent(product));

                           });
                           removeCell.appendChild(removeButton);
                           row.appendChild(removeCell);

                           tableBody.appendChild(row);
                        });
        
       
                     totalElement.innerText = total.toFixed(2);

                     var checkoutButton = document.getElementById("checkout");
                     checkoutButton.addEventListener("click", function() {
                        //提交支付请求
                        var xhr = new XMLHttpRequest();
                        xhr.open("POST", "process_payment.php", true);
                        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                        xhr.send("total=" + encodeURIComponent(total));

                        window.location.href = "payment.html"; // 转到支付页面
                        });
                     }
                  };

               xhttp.open("GET", "cart.txt", true);
               xhttp.send();
            };
            </script>

         </div>
      </div>

      <!-- cart section end -->
      <!-- footer section start -->
      <div class="footer_section layout_padding">
         <div class="container">
            <div class="footer_logo"><a href="index.php"><img src="images/footer-logo.png"></a></div>
            <div class="contact_section_2">
               <div class="row">
                  <div class="col-sm-4">
                     <h3 class="address_text">Contact Us</h3>
                     <div class="address_bt">
                        <ul>
                           <li>
                              <a href="#">
                              <i class="fa fa-map-marker" aria-hidden="true"></i><span class="padding_left10">Address : Cityu</span>
                              </a>
                           </li>
                           <li>
                              <a href="#">
                              <i class="fa fa-phone" aria-hidden="true"></i><span class="padding_left10">Call : +852 1234567890</span>
                              </a>
                           </li>
                           <li>
                              <a href="#">
                              <i class="fa fa-envelope" aria-hidden="true"></i><span class="padding_left10">Email : abc@gmail.com</span>
                              </a>
                           </li>
                        </ul>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <!-- footer section end -->
      <!-- Javascript files-->
      <script src="js/jquery.min.js"></script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.bundle.min.js"></script>
      <script src="js/jquery-3.0.0.min.js"></script>
      <script src="js/plugin.js"></script>
      <!-- sidebar -->
      <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
      <script src="js/custom.js"></script>
      <!-- javascript --> 
      <script src="js/owl.carousel.js"></script>
      <script src="https:cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>  
      <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
      <script>
         function openNav() {
           document.getElementById("mySidenav").style.width = "100%";
         }
         
         function closeNav() {
           document.getElementById("mySidenav").style.width = "0";
         }
      </script> 
   </body>
</html>
